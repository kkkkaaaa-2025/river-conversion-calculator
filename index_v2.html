<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>River Pts → RIVER 전환 트래커 (v2)</title>
  <style>
    :root { --bd:#e5e7eb; --muted:#6b7280; }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; margin:0; padding:18px; background:#fff; color:#111827;}
    h1{margin:0 0 8px; font-size:22px}
    p{margin:0 0 14px; color:#4b5563; line-height:1.4}
    .wrap{max-width:980px; margin:0 auto;}
    .card{border:1px solid var(--bd); border-radius:14px; padding:14px; margin:12px 0; background:#fff;}
    .row{display:flex; flex-wrap:wrap; gap:10px; align-items:flex-end}
    label{font-size:12px; color:#374151; display:block; margin:0 0 6px}
    select,input,button{font-size:14px; padding:10px 12px; border:1px solid var(--bd); border-radius:10px; background:#fff}
    input{min-width:220px}
    button{cursor:pointer; font-weight:700}
    button.primary{background:#111827; color:#fff; border-color:#111827}
    .tip{font-size:12px; color:var(--muted); margin-top:8px}
    .error{color:#b91c1c; font-weight:700; white-space:pre-wrap}
    .kpi{display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px}
    .kpi .item{border:1px solid var(--bd); border-radius:12px; padding:12px}
    .k{font-size:12px; color:var(--muted)}
    .v{font-size:18px; font-weight:800; margin-top:2px}
    .small{font-size:12px; color:var(--muted); margin-top:4px}
    table{width:100%; border-collapse:collapse; font-size:13px}
    th,td{border-bottom:1px solid #eee; padding:8px; text-align:right}
    th:first-child, td:first-child{text-align:left}
    .footer{margin-top:10px; font-size:12px; color:var(--muted)}
    @media (max-width:720px){
      .kpi{grid-template-columns:1fr}
      input{min-width:0; width:100%}
      select{width:100%}
      .row{align-items:stretch}
      button{width:100%}
    }
  </style>
</head>
<body>
<div class="wrap">
  <h1>River Pts → RIVER 전환 트래커 <span style="font-size:12px;color:#6b7280">(v2 · cache-safe)</span></h1>
  <p>Cloudflare Worker를 통해 <code>pts-conversion-chart</code> 데이터를 안전하게 조회합니다.</p>

  <div class="card">
    <div class="row">
      <div>
        <label>interval</label>
        <select id="interval">
          <option value="4h">4h</option>
          <option value="1d">1d</option>
        </select>
      </div>
      <div>
        <label>start (로컬)</label>
        <input id="start" type="datetime-local" />
      </div>
      <div>
        <label>end (로컬)</label>
        <input id="end" type="datetime-local" />
      </div>
      <div>
        <button id="btn" class="primary">불러오기</button>
      </div>
    </div>
    <div class="tip">start / end 비우면 최근 7일 자동 조회</div>
    <div id="err" class="error" style="display:none; margin-top:10px;"></div>
  </div>

  <div class="card">
    <div class="kpi">
      <div class="item">
        <div class="k">최근 Actual / Expected</div>
        <div class="v" id="kpiRates">-</div>
        <div class="small" id="kpiRates2">-</div>
      </div>
      <div class="item">
        <div class="k">Gap</div>
        <div class="v" id="kpiGap">-</div>
        <div class="small" id="kpiGap2">-</div>
      </div>
      <div class="item">
        <div class="k">누적 Pts</div>
        <div class="v" id="kpiPts">-</div>
      </div>
      <div class="item">
        <div class="k">누적 RIVER</div>
        <div class="v" id="kpiTok">-</div>
      </div>
      <div class="item">
        <div class="k">누적 실현 환율</div>
        <div class="v" id="kpiRealized">-</div>
      </div>
      <div class="item">
        <div class="k">마지막 타임스탬프</div>
        <div class="v" id="kpiLastTs">-</div>
      </div>
    </div>
    <div class="footer" id="debugLine"></div>
  </div>

  <div class="card">
    <table>
      <thead>
        <tr>
          <th>timestamp</th>
          <th>pts</th>
          <th>tokens</th>
          <th>actual</th>
          <th>expected</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <tr><td colspan="5" style="color:#6b7280">-</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script>
const WORKER_BASE = "https://rapid-violet-e93d.robotjh.workers.dev";
const API_PATH = "/s2/pts-conversion-chart";
const $ = (id)=>document.getElementById(id);

function toLocalInput(d){
  const p=n=>String(n).padStart(2,"0");
  return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}T${p(d.getHours())}:${p(d.getMinutes())}`;
}
function ms(v){ const t=new Date(v).getTime(); return Number.isFinite(t)?t:null; }
function fmt(x,d=2){ return Number.isFinite(x)?x.toLocaleString(undefined,{maximumFractionDigits:d}):"-"; }
function rate(x){ return Number.isFinite(x)?x.toLocaleString(undefined,{minimumFractionDigits:6,maximumFractionDigits:8}):"-"; }

function buildWorkerUrl({interval,startMs,endMs}){
  const u=new URL(WORKER_BASE+API_PATH);
  u.searchParams.set("interval",interval);
  u.searchParams.set("startTime",String(startMs));
  u.searchParams.set("endTime",String(endMs));
  return u.toString();
}

async function load(){
  $("err").style.display="none";
  $("btn").disabled=true;
  try{
    const interval=$("interval").value;
    let s=ms($("start").value);
    let e=ms($("end").value);
    if(!e) e=Date.now();
    if(!s) s=e-7*24*60*60*1000;
    const url=buildWorkerUrl({interval,startMs:s,endMs:e});

    const r=await fetch(url,{cache:"no-store"});
    if(!r.ok) throw new Error(await r.text());
    const j=await r.json();
    const rows=j.data||[];

    let sp=0,st=0;
    rows.forEach(x=>{
      sp+=Number(x.ptsAmount)||0;
      st+=Number(x.tokensAmount)||0;
    });

    const last=rows.at(-1)||{};
    $("kpiRates").textContent=`${rate(+last.actualRate)} / ${rate(+last.expectedRate)}`;
    $("kpiGap").textContent=rate((+last.actualRate)-(+last.expectedRate));
    $("kpiPts").textContent=fmt(sp,2);
    $("kpiTok").textContent=fmt(st,6);
    $("kpiRealized").textContent=rate(st/sp);
    $("kpiLastTs").textContent=last.timestamp||"-";

    $("tbody").innerHTML=rows.map(r=>`
      <tr>
        <td>${r.timestamp||""}</td>
        <td>${fmt(+r.ptsAmount,2)}</td>
        <td>${fmt(+r.tokensAmount,6)}</td>
        <td>${rate(+r.actualRate)}</td>
        <td>${rate(+r.expectedRate)}</td>
      </tr>`).join("");

    $("debugLine").textContent=`요청: ${url}`;
  }catch(e){
    $("err").style.display="block";
    $("err").textContent=e.message;
  }finally{
    $("btn").disabled=false;
  }
}

(function init(){
  const e=new Date(), s=new Date(e.getTime()-7*864e5);
  $("start").value=toLocalInput(s);
  $("end").value=toLocalInput(e);
  $("btn").onclick=load;
})();
</script>
</body>
</html>
