<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>River Pts → RIVER 전환 트래커</title>
  <style>
    :root{
      --bd:#e5e7eb; --muted:#6b7280; --bg:#f8fafc; --card:#ffffff; --txt:#111827;
      --good:#16a34a; --warn:#f59e0b; --bad:#ef4444;
    }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; margin:0; padding:18px; background:var(--bg); color:var(--txt);}
    .wrap{max-width:980px; margin:0 auto;}
    .titlebar{display:flex; gap:12px; align-items:flex-end; justify-content:space-between; flex-wrap:wrap; margin-bottom:12px}
    h1{margin:0; font-size:20px; letter-spacing:-0.2px}
    .subtitle{margin:6px 0 0; color:#4b5563; font-size:13px; line-height:1.35}
    .card{background:var(--card); border:1px solid var(--bd); border-radius:16px; padding:14px; box-shadow:0 1px 0 rgba(0,0,0,.02); margin:12px 0;}
    .row{display:flex; flex-wrap:wrap; gap:10px; align-items:center}
    .group{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    label{font-size:11px; color:#374151; display:block; margin-bottom:6px}
    select,input,button{font-size:14px; padding:10px 12px; border:1px solid var(--bd); border-radius:12px; background:#fff}
    select{min-width:120px}
    input{min-width:220px}
    button{cursor:pointer; font-weight:700}
    button.primary{background:#111827; color:#fff; border-color:#111827}
    button.ghost{background:#fff}
    .btns{display:flex; gap:8px; flex-wrap:wrap}
    .chip{
      border:1px solid var(--bd); background:#fff; padding:8px 10px; border-radius:999px;
      font-size:12px; color:#111827; cursor:pointer; user-select:none;
    }
    .chip.active{border-color:#111827; box-shadow:0 0 0 2px rgba(17,24,39,.08)}
    .hint{font-size:12px; color:var(--muted)}
    .error{color:#b91c1c; font-weight:700; white-space:pre-wrap; margin-top:10px; display:none}

    /* KPI */
    .kpis{display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px}
    .kpi{
      border:1px solid var(--bd); border-radius:14px; padding:12px; background:#fff;
      display:flex; flex-direction:column; gap:6px;
    }
    .k{font-size:11px; color:var(--muted)}
    .v{font-size:20px; font-weight:900; letter-spacing:-0.2px}
    .small{font-size:12px; color:var(--muted)}
    .statusline{
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
      padding:10px 12px; border:1px dashed var(--bd); border-radius:14px; background:#fff;
    }
    .badge{
      display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:999px;
      border:1px solid var(--bd); font-size:12px; font-weight:800;
    }
    .dot{width:10px; height:10px; border-radius:999px; background:#9ca3af}
    .badge.good .dot{background:var(--good)}
    .badge.warn .dot{background:var(--warn)}
    .badge.bad  .dot{background:var(--bad)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    details{border:1px solid var(--bd); border-radius:14px; background:#fff; padding:10px 12px}
    summary{cursor:pointer; font-weight:800; font-size:13px}
    table{width:100%; border-collapse:collapse; font-size:13px; margin-top:10px}
    th,td{border-bottom:1px solid #eee; padding:8px; text-align:right; vertical-align:top}
    th:first-child, td:first-child{text-align:left}

    @media (max-width:720px){
      .kpis{grid-template-columns:1fr}
      input{min-width:0; width:100%}
      select{width:100%}
      .row{align-items:stretch}
      .btns button{width:100%}
      .group{width:100%}
    }
  </style>
</head>

<body>
<div class="wrap">
  <div class="titlebar">
    <div>
      <h1>River Pts → RIVER 전환 트래커</h1>
      <div class="subtitle">
        전환률 회복속도(최근 6h) 기반으로 “지금 분위기”를 보는 대시보드.
        상세 테이블/디버그는 아래에서 펼쳐서 확인.
      </div>
    </div>
  </div>

  <!-- Controls -->
  <div class="card">
    <div class="row" style="justify-content:space-between;">
      <div class="group">
        <div>
          <label>interval</label>
          <select id="interval">
            <option value="1h">1h</option>
            <option value="4h" selected>4h</option>
            <option value="1d">1d</option>
          </select>
        </div>

        <div>
          <label>기간 프리셋</label>
          <div class="btns" id="presetBtns">
            <div class="chip active" data-preset="7d">7d</div>
            <div class="chip" data-preset="1d">1d</div>
            <div class="chip" data-preset="30d">30d</div>
            <div class="chip" data-preset="all">all</div>
          </div>
          <div class="hint">프리셋을 바꾸면 start/end가 자동 설정됨</div>
        </div>
      </div>

      <div class="btns">
        <button id="btn" class="primary">불러오기</button>
      </div>
    </div>

    <details style="margin-top:12px">
      <summary>고급 설정: start/end 직접 지정</summary>
      <div class="row" style="margin-top:10px">
        <div>
          <label>start (로컬)</label>
          <input id="start" type="datetime-local" />
        </div>
        <div>
          <label>end (로컬)</label>
          <input id="end" type="datetime-local" />
        </div>
        <div class="hint" style="margin-top:18px">
          start/end를 비워도 됨. (프리셋이 자동 채움)
        </div>
      </div>
    </details>

    <div id="err" class="error"></div>
  </div>

  <!-- Status -->
  <div class="card">
    <div class="statusline">
      <div class="badge" id="trafficBadge">
        <span class="dot"></span>
        <span id="trafficText">-</span>
      </div>
      <div class="hint">
        <span class="mono" id="statusText">-</span>
      </div>
    </div>

    <div class="kpis" style="margin-top:12px">
      <div class="kpi">
        <div class="k">R_now (최신 전환률)</div>
        <div class="v" id="kpiRnow">-</div>
        <div class="small" id="kpiRnow2">-</div>
      </div>

      <div class="kpi">
        <div class="k">회복속도 (최근 6h)</div>
        <div class="v" id="kpiSlope">-</div>
        <div class="small" id="kpiSlope2">-</div>
      </div>

      <div class="kpi">
        <div class="k">기간 누적 Pts / Tokens</div>
        <div class="v" id="kpiCum">-</div>
        <div class="small" id="kpiCum2">-</div>
      </div>

      <div class="kpi">
        <div class="k">기간 실현 환율 (sumTok/sumPts)</div>
        <div class="v" id="kpiRealized">-</div>
        <div class="small" id="kpiRealized2">-</div>
      </div>
    </div>
  </div>

  <!-- Details -->
  <details class="card" id="detailsBlock">
    <summary>상세 데이터 보기 (테이블/디버그)</summary>

    <div class="hint" style="margin-top:10px">
      <div>요청 URL: <span class="mono" id="debugReq">-</span></div>
      <div>범위: <span class="mono" id="debugRange">-</span></div>
      <div>R_base(7d median@4h): <span class="mono" id="debugBase">-</span></div>
    </div>

    <div style="overflow:auto; margin-top:10px">
      <table>
        <thead>
          <tr>
            <th>timestamp(UTC)</th>
            <th>ptsAmount</th>
            <th>tokensAmount</th>
            <th>actualRate</th>
            <th>expectedRate</th>
            <th>tokens/pts</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="6" style="text-align:left; color:#6b7280;">-</td></tr>
        </tbody>
      </table>
    </div>
  </details>
</div>

<script>
  // Worker / API
  const WORKER_BASE = "https://rapid-violet-e93d.robotjh.workers.dev";
  const API_PATH = "/s2/pts-conversion-chart";

  const $ = (id) => document.getElementById(id);

  // ---------- formatting ----------
  function fmtNum(x, digits=2) {
    if (!Number.isFinite(x)) return "-";
    return x.toLocaleString(undefined, { maximumFractionDigits: digits });
  }
  function fmtRate(x) {
    if (!Number.isFinite(x)) return "-";
    return x.toLocaleString(undefined, { minimumFractionDigits: 6, maximumFractionDigits: 8 });
  }
  function toLocalInputValue(d) {
    const pad = (n) => String(n).padStart(2,"0");
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }
  function parseLocalInputToMs(v) {
    const d = new Date(v);
    const ms = d.getTime();
    return Number.isFinite(ms) ? ms : null;
  }
  function parseTsMs(ts) {
    const ms = Date.parse(ts);
    return Number.isFinite(ms) ? ms : null;
  }

  // ---------- error / loading ----------
  function showError(msg) {
    const el = $("err");
    el.style.display = "block";
    el.textContent = msg;
  }
  function clearError() {
    const el = $("err");
    el.style.display = "none";
    el.textContent = "";
  }
  function setLoading(isLoading) {
    const btn = $("btn");
    btn.disabled = isLoading;
    btn.textContent = isLoading ? "불러오는 중..." : "불러오기";
  }

  // ---------- api ----------
  function buildWorkerUrl({ interval, startMs, endMs }) {
    const u = new URL(WORKER_BASE + API_PATH);
    u.searchParams.set("interval", interval);
    u.searchParams.set("startTime", String(startMs));
    u.searchParams.set("endTime", String(endMs));
    return u.toString();
  }

  // ---------- stats ----------
  function safeRateFromRow(r) {
    const p = Number(r?.ptsAmount);
    const t = Number(r?.tokensAmount);
    if (Number.isFinite(p) && p > 0 && Number.isFinite(t)) return t / p;
    const ar = Number(r?.actualRate);
    return Number.isFinite(ar) ? ar : NaN;
  }
  function median(arr) {
    const a = arr.filter(Number.isFinite).slice().sort((x,y)=>x-y);
    if (!a.length) return NaN;
    const mid = Math.floor(a.length / 2);
    return (a.length % 2) ? a[mid] : (a[mid-1] + a[mid]) / 2;
  }
  function labelTrafficLight(rNow, rBase) {
    if (!Number.isFinite(rNow) || !Number.isFinite(rBase) || rBase <= 0) return "-";
    const ratio = rNow / rBase;
    if (ratio >= 0.90) return "GREEN";
    if (ratio >= 0.80) return "YELLOW";
    return "RED";
  }
  function recoverySlopePerHour(rows, lookbackHours = 6) {
    if (!rows?.length) return NaN;

    let lastIdx = -1;
    for (let i = rows.length - 1; i >= 0; i--) {
      const r = safeRateFromRow(rows[i]);
      if (Number.isFinite(r)) { lastIdx = i; break; }
    }
    if (lastIdx < 0) return NaN;

    const lastMs = parseTsMs(rows[lastIdx].timestamp);
    const rNow = safeRateFromRow(rows[lastIdx]);
    if (!lastMs || !Number.isFinite(rNow)) return NaN;

    const targetMs = lastMs - lookbackHours * 3600 * 1000;

    let prevIdx = -1;
    for (let i = lastIdx; i >= 0; i--) {
      const ms = parseTsMs(rows[i].timestamp);
      if (!ms) continue;
      if (ms <= targetMs) {
        const r = safeRateFromRow(rows[i]);
        if (Number.isFinite(r)) { prevIdx = i; break; }
      }
    }
    if (prevIdx < 0) {
      for (let i = lastIdx - 1; i >= 0; i--) {
        const r = safeRateFromRow(rows[i]);
        if (Number.isFinite(r)) { prevIdx = i; break; }
      }
    }
    if (prevIdx < 0) return NaN;

    const prevMs = parseTsMs(rows[prevIdx].timestamp);
    const rPrev = safeRateFromRow(rows[prevIdx]);
    if (!prevMs || !Number.isFinite(rPrev)) return NaN;

    const dtHours = (lastMs - prevMs) / (3600 * 1000);
    if (!(dtHours > 0)) return NaN;

    return (rNow - rPrev) / dtHours;
  }

  async function fetchRBase7dMedian() {
    const now = Date.now();
    const endMs = now;
    const startMs = endMs - 7 * 24 * 60 * 60 * 1000;
    const url = buildWorkerUrl({ interval: "4h", startMs, endMs });

    const res = await fetch(url, { method:"GET", headers:{ "accept":"application/json" }, cache:"no-store" });
    if (!res.ok) return NaN;
    const payload = await res.json();
    const rows = payload?.data ?? [];
    const rates = rows.map(safeRateFromRow).filter(Number.isFinite);
    return median(rates);
  }

  function renderTable(rows) {
    const tb = $("tbody");
    if (!rows || rows.length === 0) {
      tb.innerHTML = `<tr><td colspan="6" style="text-align:left; color:#6b7280;">데이터 없음</td></tr>`;
      return;
    }
    tb.innerHTML = rows.map(r => {
      const p = Number(r.ptsAmount);
      const t = Number(r.tokensAmount);
      const tp = (Number.isFinite(p) && p > 0 && Number.isFinite(t)) ? (t / p) : NaN;
      return `
        <tr>
          <td>${r.timestamp ?? ""}</td>
          <td>${fmtNum(p, 2)}</td>
          <td>${fmtNum(t, 6)}</td>
          <td>${fmtRate(Number(r.actualRate))}</td>
          <td>${fmtRate(Number(r.expectedRate))}</td>
          <td>${fmtRate(tp)}</td>
        </tr>
      `;
    }).join("");
  }

  // ---------- presets ----------
  function setPreset(preset) {
    const now = new Date();
    let start = null;
    let end = new Date(now);

    if (preset === "1d") start = new Date(end.getTime() - 1*24*60*60*1000);
    if (preset === "7d") start = new Date(end.getTime() - 7*24*60*60*1000);
    if (preset === "30d") start = new Date(end.getTime() - 30*24*60*60*1000);
    if (preset === "all") start = new Date(end.getTime() - 180*24*60*60*1000); // all은 180일로 임시(너가 원하면 늘림)

    $("start").value = toLocalInputValue(start);
    $("end").value = toLocalInputValue(end);

    // chip UI
    document.querySelectorAll(".chip").forEach(c => c.classList.toggle("active", c.dataset.preset === preset));
  }

  // ---------- status badge ----------
  function setTrafficBadge(light) {
    const badge = $("trafficBadge");
    badge.classList.remove("good","warn","bad");
    if (light === "GREEN") badge.classList.add("good");
    else if (light === "YELLOW") badge.classList.add("warn");
    else if (light === "RED") badge.classList.add("bad");
    $("trafficText").textContent = light;
  }

  async function load() {
    clearError();
    setLoading(true);

    try {
      const interval = $("interval").value;

      let startMs = parseLocalInputToMs($("start").value);
      let endMs = parseLocalInputToMs($("end").value);

      const now = Date.now();
      if (!endMs) endMs = now;
      if (!startMs) startMs = endMs - 7 * 24 * 60 * 60 * 1000;

      if (startMs >= endMs) throw new Error("start가 end보다 같거나 이후입니다.");

      const reqUrl = buildWorkerUrl({ interval, startMs, endMs });

      const res = await fetch(reqUrl, { method:"GET", headers:{ "accept":"application/json" }, cache:"no-store" });
      if (!res.ok) {
        const txt = await res.text().catch(()=>"");
        throw new Error(`HTTP ${res.status}\n${txt}`);
      }

      const payload = await res.json();
      const rows = payload?.data ?? [];
      renderTable(rows);

      // sums
      let sumPts = 0, sumTok = 0;
      for (const r of rows) {
        const p = Number(r.ptsAmount);
        const t = Number(r.tokensAmount);
        if (Number.isFinite(p)) sumPts += p;
        if (Number.isFinite(t)) sumTok += t;
      }
      const realized = (sumPts > 0) ? (sumTok / sumPts) : NaN;

      // r_now
      const rNow = rows.length ? safeRateFromRow(rows[rows.length - 1]) : NaN;

      // base & slope
      const rBase = await fetchRBase7dMedian();
      const slope = recoverySlopePerHour(rows, 6);
      const light = labelTrafficLight(rNow, rBase);

      // UI
      setTrafficBadge(light);
      $("kpiRnow").textContent = fmtRate(rNow);
      $("kpiRnow2").textContent = rows.length ? `last = ${rows[rows.length - 1].timestamp}` : "-";

      const slopeText = Number.isFinite(slope) ? `${slope >= 0 ? "+" : ""}${fmtRate(slope)} / hr` : "-";
      $("kpiSlope").textContent = slopeText;

      const ratioText = (Number.isFinite(rNow) && Number.isFinite(rBase) && rBase > 0) ? (rNow / rBase * 100).toFixed(1) + "%" : "-";
      $("kpiSlope2").textContent = `R_base(7d median@4h)=${fmtRate(rBase)} · R_now/R_base=${ratioText}`;

      $("kpiCum").textContent = `${fmtNum(sumPts,2)} / ${fmtNum(sumTok,6)}`;
      $("kpiCum2").textContent = "Pts / Tokens (기간 합)";

      $("kpiRealized").textContent = fmtRate(realized);
      $("kpiRealized2").textContent = "sum(tokensAmount) / sum(ptsAmount)";

      $("statusText").textContent =
        `상태: ${light} · slope(6h)=${slopeText} · interval=${interval}`;

      $("debugReq").textContent = reqUrl;
      $("debugRange").textContent = `${new Date(startMs).toISOString()} ~ ${new Date(endMs).toISOString()}`;
      $("debugBase").textContent = fmtRate(rBase);

    } catch (e) {
      showError(String(e?.message || e));
    } finally {
      setLoading(false);
    }
  }

  // init
  (function init(){
    // default preset 7d
    setPreset("7d");

    // preset click
    $("presetBtns").addEventListener("click", (ev) => {
      const t = ev.target;
      if (t && t.classList.contains("chip")) setPreset(t.dataset.preset);
    });

    $("btn").addEventListener("click", load);
  })();
</script>
</body>
</html>
