<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>River Pts → RIVER 전환 트래커</title>
  <style>
    :root { --bd:#e5e7eb; --muted:#6b7280; --bg:#0b1220; --card:#0f1b33; --txt:#e5e7eb; }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; margin:0; padding:18px; background:#fff; color:#111827;}
    h1{margin:0 0 8px; font-size:22px}
    p{margin:0 0 14px; color:#4b5563; line-height:1.4}
    .wrap{max-width:980px; margin:0 auto;}
    .card{border:1px solid var(--bd); border-radius:14px; padding:14px; margin:12px 0; background:#fff;}
    .row{display:flex; flex-wrap:wrap; gap:10px; align-items:flex-end}
    label{font-size:12px; color:#374151; display:block; margin:0 0 6px}
    select,input,button{font-size:14px; padding:10px 12px; border:1px solid var(--bd); border-radius:10px; background:#fff}
    input{min-width:220px}
    button{cursor:pointer; font-weight:700}
    button.primary{background:#111827; color:#fff; border-color:#111827}
    .tip{font-size:12px; color:var(--muted); margin-top:8px}
    .error{color:#b91c1c; font-weight:700; white-space:pre-wrap}
    .kpi{display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px}
    .kpi .item{border:1px solid var(--bd); border-radius:12px; padding:12px}
    .k{font-size:12px; color:var(--muted)}
    .v{font-size:18px; font-weight:800; margin-top:2px}
    .small{font-size:12px; color:var(--muted); margin-top:4px}
    table{width:100%; border-collapse:collapse; font-size:13px}
    th,td{border-bottom:1px solid #eee; padding:8px; text-align:right; vertical-align:top}
    th:first-child, td:first-child{text-align:left}
    .footer{margin-top:10px; font-size:12px; color:var(--muted)}
    @media (max-width:720px){
      .kpi{grid-template-columns:1fr}
      input{min-width:0; width:100%}
      select{width:100%}
      .row{align-items:stretch}
      button{width:100%}
    }
    code{background:#f3f4f6; padding:2px 6px; border-radius:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>River Pts → RIVER 전환 트래커</h1>
    <p>
      Cloudflare Worker 프록시를 통해 <code>api-airdrop.river.inc</code>의
      <code>pts-conversion-chart</code> 데이터를 불러와 누적/비율을 계산합니다.
    </p>

    <div class="card">
      <div class="row">
        <div>
          <label>interval</label>
          <select id="interval">
            <option value="4h">4h</option>
            <option value="1d">1d</option>
          </select>
        </div>

        <div>
          <label>start (로컬)</label>
          <input id="start" type="datetime-local" />
        </div>

        <div>
          <label>end (로컬)</label>
          <input id="end" type="datetime-local" />
        </div>

        <div>
          <button id="btn" class="primary">불러오기</button>
        </div>
      </div>
      <div class="tip">
        팁: start/end를 비우고 “불러오기”를 누르면 최근 7일을 자동 조회합니다.
      </div>
      <div id="err" class="error" style="display:none; margin-top:10px;"></div>
    </div>

    <div class="card">
      <div class="kpi">
        <div class="item">
          <div class="k">최근 구간 Actual / Expected (마지막 포인트)</div>
          <div class="v" id="kpiRates">-</div>
          <div class="small" id="kpiRates2">-</div>
        </div>
        <div class="item">
          <div class="k">갭 (Actual - Expected)</div>
          <div class="v" id="kpiGap">-</div>
          <div class="small" id="kpiGap2">-</div>
        </div>
        <div class="item">
          <div class="k">누적 Pts</div>
          <div class="v" id="kpiPts">-</div>
        </div>
        <div class="item">
          <div class="k">누적 Tokens (RIVER)</div>
          <div class="v" id="kpiTok">-</div>
        </div>
        <div class="item">
          <div class="k">누적 실현 환율 (누적 Tokens / 누적 Pts)</div>
          <div class="v" id="kpiRealized">-</div>
        </div>
        <div class="item">
          <div class="k">마지막 타임스탬프 (UTC)</div>
          <div class="v" id="kpiLastTs">-</div>
        </div>
      </div>
      <div class="footer" id="debugLine"></div>
    </div>

    <div class="card">
      <h2 style="margin:0 0 10px; font-size:16px;">구간별 데이터 (ptsAmount / tokensAmount / rates)</h2>
      <div style="overflow:auto">
        <table>
          <thead>
            <tr>
              <th>timestamp(UTC)</th>
              <th>ptsAmount</th>
              <th>tokensAmount</th>
              <th>actualRate</th>
              <th>expectedRate</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="5" style="text-align:left; color:#6b7280;">-</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

<script>
  // 1) 본인 Worker 주소로 바꾸기 (끝에 슬래시 X)
  const WORKER_BASE = "https://rapid-violet-e93d.robotjh.workers.dev";

  // 2) 원본 API 경로 (Worker에서 path= 로 전달)
  const API_PATH = "/s2/pts-conversion-chart";

  const $ = (id) => document.getElementById(id);

  function toLocalInputValue(d) {
    const pad = (n) => String(n).padStart(2,"0");
    const yyyy = d.getFullYear();
    const mm = pad(d.getMonth()+1);
    const dd = pad(d.getDate());
    const hh = pad(d.getHours());
    const mi = pad(d.getMinutes());
    return `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
  }

  function parseLocalInputToMs(v) {
    // datetime-local은 로컬 시간으로 해석
    const d = new Date(v);
    const ms = d.getTime();
    return Number.isFinite(ms) ? ms : null;
  }

  function fmtNum(x, digits=2) {
    if (!Number.isFinite(x)) return "-";
    return x.toLocaleString(undefined, { maximumFractionDigits: digits });
  }

  function fmtRate(x) {
    if (!Number.isFinite(x)) return "-";
    // rate는 소수점이 길어서 유의미 자리 유지
    return x.toLocaleString(undefined, { minimumFractionDigits: 6, maximumFractionDigits: 8 });
  }

  function showError(msg) {
    const el = $("err");
    el.style.display = "block";
    el.textContent = msg;
  }
  function clearError() {
    const el = $("err");
    el.style.display = "none";
    el.textContent = "";
  }

  function buildWorkerUrl({ interval, startMs, endMs }) {
    const u = new URL(WORKER_BASE + "/");
    u.searchParams.set("path", API_PATH);
    u.searchParams.set("interval", interval);
    u.searchParams.set("startTime", String(startMs));
    u.searchParams.set("endTime", String(endMs));
    return u.toString();
  }

  function setLoading(isLoading) {
    const btn = $("btn");
    btn.disabled = isLoading;
    btn.textContent = isLoading ? "불러오는 중..." : "불러오기";
  }

  function renderTable(rows) {
    const tb = $("tbody");
    if (!rows || rows.length === 0) {
      tb.innerHTML = `<tr><td colspan="5" style="text-align:left; color:#6b7280;">데이터 없음</td></tr>`;
      return;
    }

    tb.innerHTML = rows.map(r => `
      <tr>
        <td>${r.timestamp ?? ""}</td>
        <td>${fmtNum(Number(r.ptsAmount), 2)}</td>
        <td>${fmtNum(Number(r.tokensAmount), 6)}</td>
        <td>${fmtRate(Number(r.actualRate))}</td>
        <td>${fmtRate(Number(r.expectedRate))}</td>
      </tr>
    `).join("");
  }

  function computeAndRender(payload, requestUrl) {
    const rows = payload?.data ?? [];
    renderTable(rows);

    // 누적
    let sumPts = 0;
    let sumTok = 0;
    for (const r of rows) {
      const p = Number(r.ptsAmount);
      const t = Number(r.tokensAmount);
      if (Number.isFinite(p)) sumPts += p;
      if (Number.isFinite(t)) sumTok += t;
    }

    const realized = (sumPts > 0) ? (sumTok / sumPts) : NaN;

    // 마지막 포인트(최근 구간)
    const last = rows.length ? rows[rows.length - 1] : null;
    const lastA = last ? Number(last.actualRate) : NaN;
    const lastE = last ? Number(last.expectedRate) : NaN;
    const gap = (Number.isFinite(lastA) && Number.isFinite(lastE)) ? (lastA - lastE) : NaN;

    $("kpiRates").textContent = `${fmtRate(lastA)} / ${fmtRate(lastE)}`;
    $("kpiRates2").textContent = last?.timestamp ? `last = ${last.timestamp}` : "-";

    $("kpiGap").textContent = Number.isFinite(gap) ? fmtRate(gap) : "-";
    $("kpiGap2").textContent = (Number.isFinite(gap) && Number.isFinite(lastE) && lastE !== 0)
      ? `gap% = ${(gap/lastE*100).toFixed(2)}%`
      : "-";

    $("kpiPts").textContent = fmtNum(sumPts, 2);
    $("kpiTok").textContent = fmtNum(sumTok, 6);
    $("kpiRealized").textContent = fmtRate(realized);
    $("kpiLastTs").textContent = last?.timestamp ?? "-";

    $("debugLine").textContent = `요청: ${requestUrl}`;
  }

  async function load() {
    clearError();
    setLoading(true);

    try {
      const interval = $("interval").value;

      // start/end 비어 있으면 최근 7일 자동
      let startMs = parseLocalInputToMs($("start").value);
      let endMs = parseLocalInputToMs($("end").value);

      const now = Date.now();
      if (!endMs) endMs = now;
      if (!startMs) startMs = endMs - 7 * 24 * 60 * 60 * 1000; // 7 days

      // 방어
      if (startMs >= endMs) {
        throw new Error("start가 end보다 같거나 이후입니다. 시간을 다시 선택하세요.");
      }

      const url = buildWorkerUrl({ interval, startMs, endMs });

      const res = await fetch(url, {
        method: "GET",
        headers: { "accept": "application/json" }
      });

      if (!res.ok) {
        const txt = await res.text().catch(() => "");
        throw new Error(`HTTP ${res.status}\n${txt}`);
      }

      const payload = await res.json();
      computeAndRender(payload, url);

    } catch (e) {
      showError(String(e?.message || e));
      // KPI/테이블 초기화는 하지 않음(마지막 성공값 유지)
    } finally {
      setLoading(false);
    }
  }

  // 초기값: 최근 7일 범위 세팅(로컬)
  (function init(){
    const end = new Date();
    const start = new Date(end.getTime() - 7*24*60*60*1000);
    $("start").value = toLocalInputValue(start);
    $("end").value = toLocalInputValue(end);
    $("btn").addEventListener("click", load);
  })();
</script>
</body>
</html>
