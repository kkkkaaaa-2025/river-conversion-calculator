<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>River Pts → RIVER 전환 트래커</title>

  <style>
    :root{
      --bd:#e5e7eb; --muted:#6b7280; --bg:#f8fafc; --card:#ffffff; --txt:#111827;
      --good:#16a34a; --warn:#f59e0b; --bad:#ef4444;
    }
    *{box-sizing:border-box}
    body{
      margin:0; padding:18px;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:var(--bg); color:var(--txt);
    }
    .wrap{max-width:980px; margin:0 auto;}
    h1{margin:0; font-size:20px}
    .subtitle{margin-top:6px; font-size:13px; color:#4b5563}

    .card{
      background:var(--card);
      border:1px solid var(--bd);
      border-radius:16px;
      padding:14px;
      margin:12px 0;
    }

    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .btns{display:flex; gap:8px; flex-wrap:wrap}

    .chip{
      border:1px solid var(--bd);
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      cursor:pointer;
      background:#fff;
    }
    .chip.active{
      border-color:#111827;
      box-shadow:0 0 0 2px rgba(17,24,39,.08);
    }

    .hint{font-size:12px; color:var(--muted)}

    .statusline{
      display:flex;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      border:1px dashed var(--bd);
      border-radius:14px;
      padding:12px;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border:1px solid var(--bd);
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      font-weight:900;
    }
    .dot{width:10px; height:10px; border-radius:50%; background:#9ca3af}
    .good .dot{background:var(--good)}
    .warn .dot{background:var(--warn)}
    .bad  .dot{background:var(--bad)}

    .kpis{
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:10px;
      margin-top:12px;
    }
    .kpi{
      border:1px solid var(--bd);
      border-radius:14px;
      padding:12px;
    }
    .k{font-size:11px; color:var(--muted)}
    .v{font-size:20px; font-weight:900}
    .small{font-size:12px; color:var(--muted)}

    table{width:100%; border-collapse:collapse; font-size:13px}
    th,td{border-bottom:1px solid #eee; padding:8px; text-align:right}
    th:first-child,td:first-child{text-align:left}

    @media(max-width:720px){
      .kpis{grid-template-columns:1fr}
    }
  </style>
</head>

<body>
<div class="wrap">

  <h1>River Pts → RIVER 전환 트래커</h1>
  <div class="subtitle">
    신호등 + 회복속도(6h) + ETA 기반 의사결정 보조 도구
  </div>

  <!-- 기간 프리셋 -->
  <div class="card">
    <label>기간 프리셋</label>
    <div class="hint">표시 기준: 4h · 분석 기준: 1h</div>
    <div class="btns" id="presetBtns" style="margin-top:8px">
      <div class="chip" data-preset="1d">1d</div>
      <div class="chip" data-preset="3d">3d</div>
      <div class="chip active" data-preset="7d">7d</div>
      <div class="chip" data-preset="30d">30d</div>
      <div class="chip" data-preset="all">all</div>
    </div>
    <div style="margin-top:10px">
      <button id="btn">불러오기</button>
    </div>
  </div>

  <!-- 상태 -->
  <div class="card">
    <div class="statusline">
      <div class="badge" id="trafficBadge">
        <span class="dot"></span>
        <span id="trafficText">-</span>
      </div>
      <div class="small">
        GREEN ≥ 85% · YELLOW 70~85% · RED &lt; 70%
      </div>
    </div>

    <div class="kpis">
      <div class="kpi">
        <div class="k">최신 전환율</div>
        <div class="v" id="kpiRnow">-</div>
        <div class="small" id="kpiRnow2">-</div>
      </div>
      <div class="kpi">
        <div class="k">회복속도 (6h)</div>
        <div class="v" id="kpiSlope">-</div>
      </div>
      <div class="kpi">
        <div class="k">ETA</div>
        <div class="v" id="kpiEta">-</div>
        <div class="small" id="kpiEta2">-</div>
      </div>
      <div class="kpi">
        <div class="k">기간 누적 Tokens</div>
        <div class="v" id="kpiTok">-</div>
      </div>
    </div>
  </div>

  <!-- 테이블 -->
  <div class="card">
    <table>
      <thead>
        <tr>
          <th>timestamp</th>
          <th>pts</th>
          <th>tokens</th>
          <th>tokens / pts</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <tr><td colspan="4">-</td></tr>
      </tbody>
    </table>
  </div>

  <!-- 방문자 수 -->
  <div style="margin:24px 0; text-align:center;">
    <div style="font-size:12px; color:#6b7280; margin-bottom:6px;">
      누적 방문자 수
    </div>
    <img
      src="https://hits.seeyoufarm.com/api/count/incr/badge.svg?url=https%3A%2F%2Fkkkkaaaa-2025.github.io%2Friver-conversion-calculator%2F&count_bg=%23E5E7EB&title_bg=%23111827&title=visits&edge_flat=true"
      alt="visitor counter"
    />
  </div>

</div>

<script>
/* ======================
   핵심 계산 로직
====================== */

const API = "https://rapid-violet-e93d.robotjh.workers.dev/s2/pts-conversion-chart";
const DISPLAY_INTERVAL = "4h";
const ANALYSIS_INTERVAL = "1h";
const GREEN = 0.85, RED = 0.70;

const $ = id => document.getElementById(id);

function setBadge(light){
  const b = $("trafficBadge");
  b.className = "badge " + (light==="GREEN"?"good":light==="YELLOW"?"warn":"bad");
  $("trafficText").textContent = light;
}

function fetchData(interval, start, end){
  const url = `${API}?interval=${interval}&startTime=${start}&endTime=${end}`;
  return fetch(url).then(r=>r.json()).then(j=>j.data||[]);
}

function calcRate(r){
  return r.ptsAmount > 0 ? r.tokensAmount / r.ptsAmount : NaN;
}

function human(h){
  if(!isFinite(h)) return "-";
  if(h<1) return Math.round(h*60)+"m";
  if(h<24) return Math.round(h)+"h";
  return Math.round(h/24)+"d";
}

async function load(){
  const end = Date.now();
  const start = end - 7*24*3600*1000;

  const rows4h = await fetchData(DISPLAY_INTERVAL,start,end);
  const rows1h = await fetchData(ANALYSIS_INTERVAL,start,end);

  if(!rows4h.length) return;

  // 최신 전환율
  const last = rows4h[rows4h.length-1];
  const rNow = calcRate(last);

  // 기준 전환율 (7d 중앙값)
  const rates = rows4h.map(calcRate).filter(isFinite).sort((a,b)=>a-b);
  const rBase = rates[Math.floor(rates.length/2)];

  // 신호등
  const ratio = rNow / rBase;
  const light = ratio>=GREEN?"GREEN":ratio>=RED?"YELLOW":"RED";
  setBadge(light);

  $("kpiRnow").textContent = rNow.toFixed(6);
  $("kpiRnow2").textContent = `기준 대비 ${(ratio*100).toFixed(1)}%`;

  // 회복속도 (6h)
  const a = rows1h.slice(-6);
  const slope = (calcRate(a[a.length-1]) - calcRate(a[0])) / 6;
  $("kpiSlope").textContent = (slope>=0?"+":"")+slope.toFixed(6)+"/h";

  // ETA
  if(slope>0){
    $("kpiEta").textContent =
      `${human((GREEN*rBase-rNow)/slope)} / ${human((rBase-rNow)/slope)}`;
    $("kpiEta2").textContent = "GREEN / BASE 도달 예상";
  }else{
    $("kpiEta").textContent = human((RED*rBase-rNow)/slope);
    $("kpiEta2").textContent = "RED 진입 예상";
  }

  // 누적
  const sumTok = rows4h.reduce((s,r)=>s+r.tokensAmount,0);
  $("kpiTok").textContent = sumTok.toFixed(2);

  // 테이블
  $("tbody").innerHTML = rows4h.map(r=>`
    <tr>
      <td>${r.timestamp}</td>
      <td>${r.ptsAmount}</td>
      <td>${r.tokensAmount}</td>
      <td>${calcRate(r).toFixed(6)}</td>
    </tr>
  `).join("");
}

$("btn").onclick = load;
load();
</script>
</body>
</html>
